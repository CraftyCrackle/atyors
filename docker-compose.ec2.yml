services:
  nginx:
    container_name: atyors-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/ec2.conf:/etc/nginx/conf.d/default.conf
      - certbot-webroot:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro

  api:
    container_name: atyors-api
    ports:
      - "8080:8080"
    env_file:
      - .env.ec2
    environment:
      - NODE_ENV=production
      - PORT=${PORT:-8080}
      - MONGODB_URI=${MONGODB_URI:-mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASS:-changeme_in_production}@mongodb:27017/atyors?authSource=admin}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - JWT_SECRET=${JWT_SECRET:-atyors-prod-default-jwt-secret-replace-via-ssm}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://atyors.com,https://www.atyors.com}
      - SKIP_STRIPE=${SKIP_STRIPE:-false}
      - SKIP_TWILIO=${SKIP_TWILIO:-false}
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-BKvDs89OtKGPwo6wSt0-neFvJsU4R2kZWH2GgZRiESG4-iszXn30wtkO0mIO1lktbe7lKwLyjAV_exCeP1JusfI}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-8JhnHTywkMJfQ-3EqFY6Aj9pmmAoGs1KGtF9A6z92Tw}
      - VAPID_SUBJECT=${VAPID_SUBJECT:-mailto:admin@atyors.com}
      - FROM_EMAIL=${FROM_EMAIL:-noreply@atyors.com}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_MONTHLY_PRICE_ID=${STRIPE_MONTHLY_PRICE_ID:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
    volumes:
      - uploads:/app/uploads
    command: ["node", "api-server.js"]

  web:
    container_name: atyors-web
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://atyors.com/api/v1}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://atyors.com}
        - NEXT_PUBLIC_SOCKET_URL=${NEXT_PUBLIC_SOCKET_URL:-https://atyors.com}
        - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-}
        - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY:-}
        - NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY:-}
        - NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID:-}
        - NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID:-}
        - NEXT_PUBLIC_COGNITO_REGION=${NEXT_PUBLIC_COGNITO_REGION:-us-east-1}
    ports:
      - "3000:3000"
    env_file:
      - .env.ec2
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
    volumes: []
    command: ["node", "server.js"]

  mongodb:
    container_name: atyors-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASS:-changeme_in_production}
      - MONGO_INITDB_DATABASE=atyors
    volumes:
      - mongo-prod-data:/data/db
    ports:
      - "27017:27017"

  redis:
    container_name: atyors-redis
    ports:
      - "6379:6379"

  certbot:
    image: certbot/certbot:latest
    container_name: atyors-certbot
    volumes:
      - certbot-webroot:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done'"
    depends_on:
      - nginx
    networks:
      - atyors-network

volumes:
  mongo-prod-data:
  uploads:
  certbot-webroot:
  certbot-certs:
