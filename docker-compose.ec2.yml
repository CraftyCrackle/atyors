services:
  nginx:
    container_name: atyors-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/ec2.conf:/etc/nginx/conf.d/default.conf
      - certbot-webroot:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro

  api:
    container_name: atyors-api
    ports:
      - "8080:8080"
    env_file:
      - .env.ec2
    environment:
      - NODE_ENV=production
    volumes:
      - uploads:/app/uploads
    command: ["node", "api-server.js"]

  web:
    container_name: atyors-web
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://atyors.com/api/v1}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://atyors.com}
        - NEXT_PUBLIC_SOCKET_URL=${NEXT_PUBLIC_SOCKET_URL:-https://atyors.com}
        - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-}
        - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY:-}
        - NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY:-}
        - NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID:-}
        - NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID:-}
        - NEXT_PUBLIC_COGNITO_REGION=${NEXT_PUBLIC_COGNITO_REGION:-us-east-1}
    ports:
      - "3000:3000"
    env_file:
      - .env.ec2
    environment:
      - NODE_ENV=production
    volumes: []
    command: ["node", "server.js"]

  mongodb:
    container_name: atyors-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASS:-changeme_in_production}
      - MONGO_INITDB_DATABASE=atyors
    volumes:
      - mongo-prod-data:/data/db
    ports:
      - "27017:27017"

  redis:
    container_name: atyors-redis
    ports:
      - "6379:6379"

  certbot:
    image: certbot/certbot:latest
    container_name: atyors-certbot
    volumes:
      - certbot-webroot:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done'"
    depends_on:
      - nginx
    networks:
      - atyors-network

volumes:
  mongo-prod-data:
  uploads:
  certbot-webroot:
  certbot-certs:
